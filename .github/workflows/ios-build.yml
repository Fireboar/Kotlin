name: Build Unsigned iOS IPA

on:
  workflow_dispatch:

jobs:
  build-ios:
    runs-on: macos-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Make Gradle executable
        run: chmod +x ./gradlew

      - name: Build XCFramework
        run: ./gradlew :composeApp:assembleComposeAppXCFrameworkDebugXCFramework --stacktrace --info

      - name: Create unsigned IPA
        run: |
          mkdir -p build/ipa/Payload/ComposeApp.app

          # Copy XCFramework into the .app
          cp -R composeApp/build/XCFrameworks/ComposeAppXCFramework build/ipa/Payload/ComposeApp.app/

          # Create Info.plist
          cat <<EOF > build/ipa/Payload/ComposeApp.app/Info.plist
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>CFBundleIdentifier</key>
            <string>org.example.composeapp</string>
            <key>CFBundleName</key>
            <string>ComposeApp</string>
            <key>CFBundleVersion</key>
            <string>1.0</string>
            <key>CFBundleExecutable</key>
            <string>ComposeApp</string>
            <key>CFBundlePackageType</key>
            <string>APPL</string>
          </dict>
          </plist>
          EOF

          cd build/ipa
          zip -r ComposeApp.ipa Payload
          cd ../..

      - name: Upload Unsigned IPA
        uses: actions/upload-artifact@v4
        with:
          name: ComposeApp-Unsigned-IPA
          path: build/ipa/ComposeApp.ipa
