name: Build Unsigned iOS IPA

on:
  workflow_dispatch:

jobs:
  build-ios:
    runs-on: macos-latest

    steps:
      # 1️⃣ Checkout Repository
      - name: Checkout
        uses: actions/checkout@v4

      # 2️⃣ Set up JDK (für Kotlin Multiplatform)
      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      # 3️⃣ Make Gradle executable
      - name: Make gradlew executable
        run: chmod +x ./gradlew

      # 4️⃣ Build iOS App (Release) – komplette App, nicht nur Framework
      - name: Build iOS App
        run: |
          ./gradlew linkReleaseFrameworkIosArm64 --stacktrace --info
          ./gradlew assembleReleaseXCFramework --stacktrace --info

      # 5️⃣ Create unsigned IPA
      - name: Create unsigned IPA
        run: |
          mkdir -p build/ipa/Payload
          # Kopiere das echte .app Release-Build ins Payload-Verzeichnis
          cp -R composeApp/build/bin/iosArm64/releaseExecutable/ComposeApp.app build/ipa/Payload/
          cd build/ipa
          zip -r ComposeApp.ipa Payload
          cd ../..

      # 6️⃣ Check IPA contents
      - name: Check IPA contents
        run: ls -l build/ipa

      # 7️⃣ Upload IPA artifact
      - name: Upload Unsigned IPA
        uses: actions/upload-artifact@v4
        with:
          name: Unsigned-iOS-App
          path: build/ipa/ComposeApp.ipa
