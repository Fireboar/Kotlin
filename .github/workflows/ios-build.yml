name: Build Unsigned iOS IPA

on:
  workflow_dispatch:

jobs:
  build-ios:
    runs-on: macos-latest

    steps:
      # 1️⃣ Checkout Repository
      - name: Checkout
        uses: actions/checkout@v4

      # 2️⃣ Set up JDK für Kotlin Multiplatform
      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      # 3️⃣ Make Gradle executable
      - name: Make Gradle executable
        run: chmod +x ./gradlew

      # 4️⃣ Build iOS Frameworks
      - name: Build iOS Frameworks
        run: |
          ./gradlew composeApp:assembleXCFramework --stacktrace --info

      # 5️⃣ Package a minimal .app for AltStore
      - name: Create unsigned IPA
        run: |
          mkdir -p build/ipa/Payload/ComposeApp.app

          # Kopiere das XCFramework in die .app
          cp -R composeApp/build/XCFrameworks/release/ComposeApp.xcframework build/ipa/Payload/ComposeApp.app/

          # Info.plist erstellen
          cat <<EOF > build/ipa/Payload/ComposeApp.app/Info.plist
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>CFBundleIdentifier</key>
            <string>org.example.composeapp</string>
            <key>CFBundleName</key>
            <string>ComposeApp</string>
            <key>CFBundleVersion</key>
            <string>1.0</string>
            <key>CFBundleExecutable</key>
            <string>ComposeApp</string>
            <key>CFBundlePackageType</key>
            <string>APPL</string>
          </dict>
          </plist>
          EOF

          cd build/ipa
          zip -r ComposeApp.ipa Payload
          cd ../..

      # 6️⃣ Upload IPA artifact
      - name: Upload Unsigned IPA
        uses: actions/upload-artifact@v4
        with:
          name: ComposeApp-Unsigned-IPA
          path: build/ipa/ComposeApp.ipa
